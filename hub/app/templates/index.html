<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hub.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header class="hub-header">
            <h1>üè† {{ hub.name }}</h1>
            <p class="hub-description">{{ hub.description }}</p>
        </header>

        <main class="apps-grid">
            {% for app in apps %}
            <div class="app-card" data-app-id="{{ app.id }}" data-port="{{ app.port }}" style="--app-color: {{ app.color }}">
                <div class="app-icon">{{ app.icon }}</div>
                <div class="app-info">
                    <h2 class="app-name">{{ app.name }}</h2>
                    <p class="app-description">{{ app.description }}</p>
                </div>
                <div class="app-status">
                    <span class="status-indicator {% if app.status.running %}running{% else %}stopped{% endif %}">
                        {% if app.status.running %}‚óè Running{% else %}‚óã Stopped{% endif %}
                    </span>
                    <span class="app-port">Port: {{ app.port }}</span>
                </div>
                <div class="app-actions">
                    {% if app.status.running %}
                    <button class="btn btn-open" onclick="openApp('{{ app.id }}')">
                        Open App
                    </button>
                    <button class="btn btn-stop" onclick="stopApp('{{ app.id }}')">
                        Stop
                    </button>
                    <button class="btn btn-restart" onclick="restartApp('{{ app.id }}')">
                        Restart
                    </button>
                    <button class="btn btn-logs" onclick="viewLogs('{{ app.id }}')">
                        Logs
                    </button>
                    {% else %}
                    <button class="btn btn-start" onclick="startApp('{{ app.id }}')">
                        Start App
                    </button>
                    <button class="btn btn-logs" onclick="viewLogs('{{ app.id }}')">
                        Logs
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}

            {% if not apps %}
            <div class="no-apps">
                <p>No apps configured yet.</p>
                <p>Add apps to <code>config.yaml</code> to get started.</p>
            </div>
            {% endif %}
        </main>

        <footer class="hub-footer">
            <p>{{ hub.name }} v{{ hub.version }}</p>
        </footer>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast hidden"></div>

    <!-- Logs modal -->
    <div id="logs-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="logs-title">App Logs</h3>
                <button class="close-btn" onclick="closeLogsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="logs-controls">
                    <button class="btn btn-small" onclick="switchLogType('stdout')">stdout</button>
                    <button class="btn btn-small" onclick="switchLogType('stderr')">stderr</button>
                    <button class="btn btn-small" onclick="refreshLogs()">Refresh</button>
                </div>
                <pre id="logs-content" class="logs-content">Loading logs...</pre>
            </div>
        </div>
    </div>

    <script>
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }

        // Helper function to create buttons safely (prevents XSS)
        function createButton(text, className, onClick) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = className;
            btn.addEventListener('click', onClick);
            return btn;
        }

        // Update app card status
        function updateAppCard(appId, status) {
            const card = document.querySelector(`[data-app-id="${appId}"]`);
            if (!card) return;

            const statusIndicator = card.querySelector('.status-indicator');
            const actionsDiv = card.querySelector('.app-actions');

            // Update port display if present
            const portSpan = card.querySelector('.app-port');
            if (portSpan && status.port !== undefined) {
                portSpan.textContent = `Port: ${status.port}`;
            }

            if (status.running) {
                statusIndicator.className = 'status-indicator running';
                statusIndicator.textContent = '‚óè Running';
                // Clear and rebuild buttons safely to prevent XSS
                actionsDiv.replaceChildren();
                actionsDiv.appendChild(createButton('Open App', 'btn btn-open', () => openApp(appId)));
                actionsDiv.appendChild(createButton('Stop', 'btn btn-stop', () => stopApp(appId)));
                actionsDiv.appendChild(createButton('Restart', 'btn btn-restart', () => restartApp(appId)));
                actionsDiv.appendChild(createButton('Logs', 'btn btn-logs', () => viewLogs(appId)));
            } else {
                statusIndicator.className = 'status-indicator stopped';
                statusIndicator.textContent = '‚óã Stopped';
                // Clear and rebuild buttons safely to prevent XSS
                actionsDiv.replaceChildren();
                actionsDiv.appendChild(createButton('Logs', 'btn btn-logs', () => viewLogs(appId)));
                actionsDiv.appendChild(createButton('Start App', 'btn btn-start', () => startApp(appId)));
            }
        }

        // Start an application
        async function startApp(appId) {
            showToast('Starting app...', 'info');

            try {
                const response = await fetch(`/api/apps/${appId}/start`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message || 'App started!', 'success');
                    // Update UI to show running state and attach Logs button
                    // Prefer explicit port from API response or fallback to config
                    const newPort = data.port || (data.url ? new URL(data.url).port : undefined);
                    updateAppCard(appId, { running: true, port: newPort });
                } else {
                    showToast(data.error || 'Failed to start app', 'error');
                }
            } catch (error) {
                showToast('Error starting app: ' + error.message, 'error');
            }
        }

        // Stop an application
        async function stopApp(appId) {
            showToast('Stopping app...', 'info');
            
            try {
                const response = await fetch(`/api/apps/${appId}/stop`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || 'App stopped!', 'success');
                    updateAppCard(appId, { running: false });
                } else {
                    showToast(data.error || 'Failed to stop app', 'error');
                }
            } catch (error) {
                showToast('Error stopping app: ' + error.message, 'error');
            }
        }

        // Restart an application
        async function restartApp(appId) {
            showToast('Restarting app...', 'info');
            
            try {
                const response = await fetch(`/api/apps/${appId}/restart`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message || 'App restarted!', 'success');
                    updateAppCard(appId, { running: true });
                } else {
                    showToast(data.error || 'Failed to restart app', 'error');
                }
            } catch (error) {
                showToast('Error restarting app: ' + error.message, 'error');
            }
        }

        // Open application in new tab
        // Uses locally-constructed URL from known-safe port values to prevent open redirect
        async function openApp(appId) {
            try {
                // First, get the app status to find the port from the cards we already have
                const card = document.querySelector(`[data-app-id="${appId}"]`);
                if (!card) {
                    showToast('App card not found', 'error');
                    return;
                }

                // Get the port from the card dataset (this was set from our own server data)
                const port = card.dataset.port;
                if (!port || isNaN(parseInt(port))) {
                    showToast('Invalid app configuration', 'error');
                    return;
                }

                // Construct a safe URL from the validated port number
                // Only localhost URLs are allowed
                const safeUrl = `http://127.0.0.1:${parseInt(port)}`;
                window.open(safeUrl, '_blank');

                // Also record activity via API (fire-and-forget)
                fetch(`/api/apps/${appId}/activity`, { method: 'POST' }).catch(() => {});

            } catch (error) {
                showToast('Error opening app: ' + error.message, 'error');
            }
        }

        // Periodically refresh status
        async function refreshStatus() {
            try {
                const response = await fetch('/api/apps');
                const data = await response.json();
                
                if (data.success && data.apps) {
                    data.apps.forEach(app => {
                        updateAppCard(app.id, app.status);
                    });
                }
            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }

        // Logs modal functionality
        let currentAppId = null;
        let currentLogType = 'stderr';

        function viewLogs(appId) {
            currentAppId = appId;
            currentLogType = 'stderr';
            document.getElementById('logs-title').textContent = `Logs for ${appId}`;
            document.getElementById('logs-modal').classList.remove('hidden');
            loadLogs();
        }

        function closeLogsModal() {
            document.getElementById('logs-modal').classList.add('hidden');
            currentAppId = null;
        }

        function switchLogType(type) {
            currentLogType = type;
            loadLogs();
        }

        function refreshLogs() {
            loadLogs();
        }

        async function loadLogs() {
            if (!currentAppId) return;

            const logsContent = document.getElementById('logs-content');
            logsContent.textContent = 'Loading logs...';

            try {
                const response = await fetch(`/api/apps/${currentAppId}/logs?type=${currentLogType}&lines=200`);
                const data = await response.json();

                if (data.success) {
                    logsContent.textContent = data.log_content || 'No logs available';
                } else {
                    logsContent.textContent = `Error loading logs: ${data.error}`;
                }
            } catch (error) {
                logsContent.textContent = `Error: ${error.message}`;
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeLogsModal();
            }
        });

        // Refresh status every 10 seconds
        setInterval(refreshStatus, 10000);
    </script>
</body>
</html>
